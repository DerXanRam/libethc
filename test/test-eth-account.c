#include "test.h"
#include <ethc/account.h>
#include <ethc/hex.h>
#include <ethc/keccak256.h>
#include <tap.h>

void test_eth_account_from_privkey(void) {
  struct eth_account account;
  char sprivkey[65], spubkey[129], saddress[41];

  uint8_t privkey[32] = {0xdc, 0xdf, 0x91, 0xb7, 0xb2, 0x9c, 0x4c, 0x06,
                         0x77, 0x33, 0x1b, 0x65, 0x5c, 0x0c, 0x6c, 0xf4,
                         0xe7, 0x1b, 0x6f, 0x87, 0x19, 0x27, 0x3a, 0x11,
                         0x2e, 0xe6, 0x5b, 0x63, 0x9b, 0x88, 0x8f, 0xfa};

  ok(eth_account_from_privkey(&account, privkey) == ETHC_SUCCESS);
  ok(eth_account_privkey_get(sprivkey, &account) == ETHC_SUCCESS);
  ok(eth_account_pubkey_get(spubkey, &account) == ETHC_SUCCESS);
  ok(eth_account_address_get(saddress, &account) == ETHC_SUCCESS);

  is(sprivkey,
     "dcdf91b7b29c4c0677331b655c0c6cf4e71b6f8719273a112ee65b639b888ffa");
  is(spubkey,
     "0699e15ad3e44a9ad7050b87cbcc30c6673b97417656604a6c4baa953e19b373c7a274e10"
     "1b777dd2c447fed7757e1f72a312b045777ab69c60deb1b0003aba5");
  is(saddress, "ed854c0a70c7eb7a720310f4ac0d8b6658e39539");
}

void test_eth_account_sign(void) {
  struct eth_account account;
  struct eth_signed signed_data;
  uint8_t data[3] = {'e', 't', 'h'};
  uint8_t privkey[32] = {0xdc, 0xdf, 0x91, 0xb7, 0xb2, 0x9c, 0x4c, 0x06,
                         0x77, 0x33, 0x1b, 0x65, 0x5c, 0x0c, 0x6c, 0xf4,
                         0xe7, 0x1b, 0x6f, 0x87, 0x19, 0x27, 0x3a, 0x11,
                         0x2e, 0xe6, 0x5b, 0x63, 0x9b, 0x88, 0x8f, 0xfa};
  uint8_t r[32] = {0xf4, 0xd8, 0x59, 0x55, 0xdb, 0x51, 0x4c, 0x3e,
                   0xef, 0x3c, 0x7c, 0xa0, 0xc8, 0x7b, 0x1a, 0xf9,
                   0x25, 0x76, 0x31, 0x83, 0x42, 0xb0, 0xc5, 0x18,
                   0x9c, 0x7c, 0xbb, 0x33, 0xcc, 0x2d, 0x1e, 0xe2};
  uint8_t s[32] = {0x12, 0x44, 0x78, 0x1a, 0xcc, 0x9d, 0x7f, 0x78,
                   0xac, 0xda, 0x20, 0x3b, 0x87, 0x3a, 0xdc, 0x1f,
                   0xf7, 0xbb, 0xe1, 0xc2, 0x00, 0x66, 0x12, 0x3d,
                   0x9e, 0x61, 0x5f, 0x86, 0xa6, 0xaa, 0x5e, 0xd0};

  ok(eth_account_from_privkey(&account, privkey) == ETHC_SUCCESS);
  ok(eth_account_sign(&signed_data, (const struct eth_account*)&account, data,
                      3));
  cmp_mem(signed_data.r, r, 32);
  cmp_mem(signed_data.s, s, 32);
}
